# HSE: Системы хранения данных — Итоговое задание

## Data Vault для SampleSuperstore

Проект реализует полноценное хранилище данных на основе методологии Data Vault 2.0 для анализа продаж из датасета SampleSuperstore. Реализация выполнена в Yandex Cloud Managed Greenplum с автоматизированным ETL процессом.

---

## Структура проекта

```
HSE_DataStorageSystems_FinalAssignment/
├── sql/ # SQL скрипты
│   ├── 00_schemas.sql # Создание схем
│   ├── 01_stage.sql # Стейджинг таблица
│   ├── 10_hubs.sql # Хабы и их сателлиты
│   ├── 20_links.sql # Линки и их сателлиты
│   ├── 40_constraints.sql # Ограничения и индексы
│   ├── 50_etl.sql # ETL процесс
│   └── 60_verify.sql # Проверка и аналитика
├── etl/ # Python ETL утилиты
│   ├── __init__.py
│   ├── db.py# Подключение к Greenplum
│   ├── stage_load.py # Загрузка в stage
│   ├── run_sql.py # Запуск SQL файлов
│   ├── run_all.py # Полный ETL процесс
│   └── verify.py # Проверка результатов
├── SampleSuperstore.csv # Исходный датасет
├── pyproject.toml # Конфигурация проекта
└── requirements.txt # Python зависимости
```

---

## Дизайн Data Vault

### Обзор архитектуры

<img width="1207" height="820" alt="Screenshot 2025-10-14 at 21 30 08" src="https://github.com/user-attachments/assets/5df25be0-0c5b-4902-b15b-bacd0232cb5c" />

### Исходные данные

Датасет SampleSuperstore содержит:
- **Способ доставки** (Ship Mode)
- **Сегмент клиента** (Segment)
- **География**: Страна, Город, Штат, Почтовый индекс, Регион
- **Товарная иерархия**: Категория, Подкатегория
- **Метрики**: Продажи, Количество, Скидка, Прибыль

### Компоненты Data Vault

#### Хабы (Hubs)
Хабы представляют основные бизнес-сущности:

| Хаб | Описание | Бизнес-ключ |
|-----|----------|-------------|
| **H_SHIP_MODE** | Способы доставки | md5(upper(trim(Ship Mode))) |
| **H_SEGMENT** | Сегменты клиентов | md5(upper(trim(Segment))) |
| **H_GEOGRAPHY** | Географические локации | md5(concat_ws('\|', Country, State, City, Postal_Code, Region)) |
| **H_CATEGORY** | Категории товаров | md5(upper(trim(Category))) |
| **H_SUB_CATEGORY** | Подкатегории товаров | md5(upper(trim(Sub-Category))) |

#### Линки (Links)

**L_SALE** - Связь всех измерений продажи
- Соединяет: Ship Mode, Segment, Geography, Category, Sub-Category
- Хеш-ключ: md5(конкатенация хеш-ключей всех связанных хабов)
- Обеспечивает уникальную идентификацию каждой продажи

#### Сателлиты (Satellites)

| Сателлит | Родитель | Атрибуты |
|----------|----------|----------|
| **S_SHIP_MODE** | H_SHIP_MODE | Текстовое описание |
| **S_SEGMENT** | H_SEGMENT | Текстовое описание |
| **S_GEOGRAPHY** | H_GEOGRAPHY | Страна, Штат, Город, Индекс, Регион |
| **S_CATEGORY** | H_CATEGORY | Текстовое описание |
| **S_SUB_CATEGORY** | H_SUB_CATEGORY | Текстовое описание |
| **S_SALE_METRICS** | L_SALE | Sales, Quantity, Discount, Profit |

---

## Технические особенности

### Оптимизация для Greenplum

**Типы данных:**
- Хеш-ключи: `char(32)` для MD5
- Текстовые поля: `text`
- Числовые метрики: `numeric(18,4)`

**Распределение таблиц:**
- Хабы → по хеш-ключу
- Линки → по хеш-ключу линка
- Сателлиты → по родительскому хеш-ключу

**Оптимизация загрузки:**
- `NOT VALID` для внешних ключей
- Отложенная валидация ограничений
- Параллельная загрузка хабов

### Правила загрузки данных

**1. Нормализация ключей:**
- Удаление пробелов (trim)
- Приведение к верхнему регистру (upper)
- Конкатенация через '|' для составных ключей

**2. Порядок загрузки:**
1. Хабы (параллельно)
2. Линки
3. Сателлиты

**3. Контроль качества:**
- Запрет NULL в бизнес-ключах
- Контроль целостности через внешние ключи
- Отслеживание изменений через hashdiff
- Временные метки для каждой версии

---

## Результаты загрузки

<img width="1512" height="982" alt="Screenshot 2025-10-14 at 21 22 38" src="https://github.com/user-attachments/assets/e21585df-160b-4714-bc26-e57436506cea" />

---

## Пример аналитики: Продажи по регионам и категориям (ТОП-5)

<img width="1512" height="982" alt="Screenshot 2025-10-14 at 21 22 53" src="https://github.com/user-attachments/assets/21bce3ab-b930-4699-94ab-897cd09148f0" />
